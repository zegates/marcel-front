<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="shop-products-data.html">
<link rel="import" href="shop-common-styles.html">

<dom-module id="shop-products">

    <template>

        <style include="shop-common-styles">

            .hero-image {
                position: relative;
                height: 320px;
                overflow: hidden;
                margin-bottom: 32px;
            }

            .hero-image {
                --shop-image-img: {
                    position: absolute;
                    top: 0;
                    bottom: 0;
                    left: -9999px;
                    right: -9999px;
                    max-width: none;
                };
            }

            .grid {
                @apply(--layout-horizontal);
                @apply(--layout-wrap);
                @apply(--layout-justified);
                margin: 0 10px 32px 10px;
                padding: 0;
                list-style: none;
            }

            .grid li {
                -webkit-flex: 1 1;
                flex: 1 1;
                -webkit-flex-basis: 33%;
                flex-basis: 33%;
                max-width: 33%;
            }

            .grid a {
                display:block;
                text-decoration: none;
            }

            @media (max-width: 767px) {
                .hero-image {
                    display: none;
                }

                .grid  li {
                    -webkit-flex-basis: 50%;
                    flex-basis: 50%;
                    max-width: 50%;
                }
            }

        </style>

        <!--
          app-route provides the name of the category.
        -->
        <app-route
                route="[[route]]"
                pattern="/:products"
                data="{{routeData}}"></app-route>

        <shop-category-data
                id="categoryData"
                failure="{{failure}}"></shop-category-data>
        <!--
          shop-product-data provides the category data for a given product name.
        -->
        <shop-products-data
                id="productData"
                product-name="[[routeData.products]]"
                products="{{products}}"
                failure="{{failure}}"></shop-products-data>

        <!--<shop-image-->
        <!--alt="[[category.title]]"-->
        <!--src="[[category.image]]"-->
        <!--placeholder-img="[[category.placeholder]]" class="hero-image"></shop-image>-->

        <header>
            <h1>Search Results</h1>
        </header>

        <ul class="grid" hidden$="[[failure]]">
            <template is="dom-repeat" items="{{products}}">
                <!--<template is="dom-repeat" items="{{_getListItems(category.items)}}">-->
                <li>
                    <!--found-->
                    <a href$="[[_getItemHref(item)]]"><shop-list-item item="[[item]]"></shop-list-item></a>
                </li>
            </template>
        </ul>

        <!--
          shop-network-warning shows a warning message when the items can't be rendered due
          to network conditions.
        -->
        <shop-network-warning
                hidden$="[[!failure]]"
                offline="[[offline]]"
                on-try-reconnect="_tryReconnect"></shop-network-warning>

    </template>

    <script>

        Polymer({

            is: 'shop-products',

            properties: {

                product: Object,

                route: Object,

                routeData: Object,

                visible: Boolean,

                offline: {
                    type: Boolean,
                    observer: '_offlineChanged'
                },

                failure: Boolean

            },

//      catData : this.$.categoryData,
//
            observers: [
                '_categoryChanged(product, visible)'
            ],

            ready: function(){
//        this.async(function () {
//          this.visible = !this.visible;
//        }, 2000);
            },

            _getListItems: function(items) {
                // Return placeholder items when the items haven't loaded yet.
                return items || [{},{},{}];
            },

            _getItemHref: function(item) {
                // By returning null when `itemId` is undefined, the href attribute won't be set and
                // the link will be disabled.
        return "#";
//                return item.idproducts ? ['/detail', this.category.category, item.idproducts].join('/') : null;
            },

            _getPluralizedQuantity: function(quantity) {
                if (!quantity) {
                    return '';
                }
                var pluralizedQ = quantity === 1 ? 'item' : 'items';
                return  '(' + quantity + ' ' + pluralizedQ + ')';
            },

            _categoryChanged: function(category, visible) {
                if (visible) {
                    this.debounce('change-section', function() {
                        // Notify the category and the page's title
                        if(this.categoryName != null){
                            this.$.categoryData.categoryName = this.categoryName;
                        }
                        if(category != null) {
                            this.fire('change-section', {
                                category: category.category,
                                title: category.category_name
                            });
                        }
                    });

                }
            },

            _tryReconnect: function() {
                this.$.productData.refresh();
            },

            _offlineChanged: function(offline) {
                if (!offline) {
                    this._tryReconnect();
                }
            }

        });

    </script>

</dom-module>
